name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build and Test (${{ matrix.os }}, ${{ matrix.backend }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        backend: [opencv, gstreamer, ffmpeg, all]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install base dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          pkg-config \
          libopencv-dev \
          libgtest-dev \
          libcurl4-openssl-dev

    - name: Install GStreamer
      if: matrix.backend == 'gstreamer' || matrix.backend == 'all'
      run: |
        sudo apt-get install -y \
          libunwind-dev \
          libgstreamer1.0-dev \
          libgstreamer-plugins-base1.0-dev \
          libgstreamer-plugins-bad1.0-dev \
          gstreamer1.0-plugins-base \
          gstreamer1.0-plugins-good \
          gstreamer1.0-plugins-bad \
          gstreamer1.0-plugins-ugly \
          gstreamer1.0-libav \
          gstreamer1.0-tools

    - name: Install FFmpeg
      if: matrix.backend == 'ffmpeg' || matrix.backend == 'all'
      run: |
        sudo apt-get install -y \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libswscale-dev \
          libavdevice-dev

    - name: Configure CMake (OpenCV only)
      if: matrix.backend == 'opencv'
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTS=ON

    - name: Configure CMake (GStreamer)
      if: matrix.backend == 'gstreamer'
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTS=ON \
          -DUSE_GSTREAMER=ON

    - name: Configure CMake (FFmpeg)
      if: matrix.backend == 'ffmpeg'
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTS=ON \
          -DUSE_FFMPEG=ON

    - name: Configure CMake (All backends)
      if: matrix.backend == 'all'
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTS=ON \
          -DUSE_GSTREAMER=ON \
          -DUSE_FFMPEG=ON

    - name: Build
      run: cmake --build build --config Release

    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure --verbose

    - name: Upload build artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ matrix.os }}-${{ matrix.backend }}
        path: |
          build/CMakeFiles/CMakeOutput.log
          build/CMakeFiles/CMakeError.log
          build/Testing/Temporary/LastTest.log
        retention-days: 7

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-format \
          cppcheck \
          libopencv-dev

    - name: Check code formatting
      run: |
        find src include tests app -name '*.cpp' -o -name '*.hpp' | while read file; do
          if ! clang-format --dry-run -Werror "$file" 2>/dev/null; then
            echo "Format check would fail for: $file"
          fi
        done

    - name: Run cppcheck
      run: |
        cppcheck --enable=all --suppress=missingIncludeSystem \
          --inline-suppr --error-exitcode=0 \
          -I include -I src \
          src/ app/ tests/ 2>&1 | tee cppcheck-report.txt

    - name: Upload cppcheck report
      uses: actions/upload-artifact@v4
      with:
        name: cppcheck-report
        path: cppcheck-report.txt
        retention-days: 30

  build-sanitizers:
    name: Build with Sanitizers
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        sanitizer: [address, undefined, thread]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libopencv-dev \
          libgtest-dev \
          libcurl4-openssl-dev \
          clang

    - name: Configure CMake with ${{ matrix.sanitizer }} sanitizer
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_FLAGS="-fsanitize=${{ matrix.sanitizer }} -fno-omit-frame-pointer" \
          -DCMAKE_C_FLAGS="-fsanitize=${{ matrix.sanitizer }} -fno-omit-frame-pointer" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=${{ matrix.sanitizer }}" \
          -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=${{ matrix.sanitizer }}" \
          -DBUILD_TESTS=ON

    - name: Build
      run: cmake --build build --config Debug

    - name: Run tests with ${{ matrix.sanitizer }} sanitizer
      run: |
        cd build
        ctest --output-on-failure --verbose
      env:
        ASAN_OPTIONS: detect_leaks=1:symbolize=1
        UBSAN_OPTIONS: print_stacktrace=1
        TSAN_OPTIONS: second_deadlock_stack=1

  cross-platform:
    name: Cross-Platform Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-13, macos-latest]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies (macOS)
      run: |
        brew update
        brew install cmake ninja opencv googletest

    - name: Configure CMake
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTS=ON

    - name: Build
      run: cmake --build build --config Release

    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure --verbose
